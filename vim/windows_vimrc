vim9script

filetype plugin indent on
syntax on
set background=dark
colorscheme evening
set shell=C:\Program\ Files\PowerShell\7\pwsh.exe
set shellcmdflag=-Command
set backupdir=C:\Users\futur\vimfiles\backup
set directory=C:\Users\futur\vimfiles\swap
set undodir=C:\Users\futur\vimfiles\undo
set encoding=UTF-8
set fileencodings=utf-8,default
set nowrap
set shiftwidth=2
set tabstop=2
set textwidth=78
set backspace=indent,eol,start
set numberwidth=4
set relativenumber
set incsearch 
set ruler
set showcmd
set viminfo='20,\"50
set helplang=en,de
set autoread
set timeout
set ttimeout
set ttimeoutlen=100
set wildmenu
g:wildoptions = "pum"
g:mapleader = " "
g:maplocalleader = ","

if empty(glob('C:\Users\futur\vimfiles\autoload\plug.vim'))
	silent execute iwr -useb https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim |` ni C:\Users\futur\vimfiles\autoload\plug.vim -Force
	# create symlink in windows
	silent execute New-Item -ItemType SymbolicLink -Target C:\Users\futur\dotfiles\vim\windows_vimrc -Path vimdir\vimrc
	autocmd VimEnter * PlugInstall --sync | source $MYVIMRC
endif
plug#begin('C:\Users\futur\vimfiles\vim-plug')
# Plug 'preservim/nerdtree' # filesystem explorer
# Plug 'ryanoasis/vim-devicons' # icons for nerdtree and other plugins
# Plug 'tpope/vim-surround'
# Plug 'tpope/vim-endwise' # automatically write 'end' for lua
# Plug 'junegunn/fzf', { 'do': { -> fzf#install() } }
# Plug 'junegunn/fzf.vim'
# Plug 'prabirshrestha/vim-lsp'
# Plug 'prabirshrestha/asyncomplete.vim'
# Plug 'prabirshrestha/asyncomplete-lsp.vim'
# Plug 'preservim/nerdcommenter' # easy comments
plug#end()

# nnoremap <Leader>b <Cmd>Buffers<CR>
nnoremap <Leader>c <Cmd>edit $MYVIMRC<CR>
# nnoremap <Leader>e <Cmd>NERDTreeToggle<CR>
# nnoremap <Leader>f <Cmd>Files<CR>
nnoremap <Leader>r <Cmd>source $MYVIMRC<CR>
# nnoremap <Leader>s <Cmd>Rg<CR>
noremap \ :term ++kill="kill"<CR>
tnoremap \ <CR>exit<CR>>

var c_lspinfo = {
	'name': 'clangd',
	'cmd': [ &shell, &shellcmdflag, 'clangd', '--background-index'],
	'allowlist': ['c'],
	'blocklist': [],
	'config': {},
	'workspace_config': {}
}
var lua_lspinfo = {
	'name': 'lua-language-server',
	'cmd': [ &shell, &shellcmdflag, 'lua-language-server', '--stdio'],
	'allowlist': ['lua'],
	'blocklist': [],
	'config': {},
	'workspace_config': {}
}
var python_lspinfo = {
	'name': 'pylsp',
	'cmd': [ &shell, &shellcmdflag, 'pylsp'],
	'allowlist': ['python'],
	'blocklist': [],
	'config': {},
	'workspace_config': {}
}
var rust_lsp_info = {
	'name': 'rust-analyzer',
	'cmd': [ &shell, &shellcmdflag, 'rust-analyzer', '--log-file', './rust.log'],
	'allowlist': ['rust'],
	'blocklist': [],
	'config': {},
	'workspace_config': {}
}
var vim_lsp_info = {
	'name': 'vim-language-server',
	'cmd': [ &shell, &shellcmdflag, 'vim-language-server', '--stdio' ],
	'allowlist': ['vim'],
	'initialization_options': {
		'vimruntime': $VIMRUNTIME,
		'runtimepath': &rtp
	},
	'blocklist': [],
	'config': {},
	'workspace_config': {}
}

if executable('clangd')
	au User lsp_setup lsp#register_server(c_lspinfo)
endif
if executable('lua-language-server')
	au User lsp_setup lsp#register_server(lua_lspinfo)
endif
if executable('pylsp')
	au User lsp_setup lsp#register_server(python_lspinfo)
endif
if executable('rust-analyzer')
	au User lsp_setup lsp#register_server(rust_lsp_info)
endif
if executable('vim-language-server')
	au User lsp_setup lsp#register_server(vim_lsp_info)
endif

def On_lsp_buffer_enabled(): void
	setlocal omnifunc=lsp#complete
	setlocal signcolumn=yes
	if exists('+tagfunc') | setlocal tagfunc=lsp#tagfunc | endif
	nmap <buffer> gd <plug>(lsp-definition)
	nmap <buffer> gs <plug>(lsp-document-symbol-search)
	nmap <buffer> gS <plug>(lsp-workspace-symbol-search)
	nmap <buffer> gr <plug>(lsp-references)
	nmap <buffer> gi <plug>(lsp-implementation)
	nmap <buffer> gt <plug>(lsp-type-definition)
	nmap <buffer> <leader>rn <plug>(lsp-rename)
	nmap <buffer> [g <plug>(lsp-previous-diagnostic)
	nmap <buffer> ]g <plug>(lsp-next-diagnostic)
	nmap <buffer> K <plug>(lsp-hover)
	nnoremap <buffer> <expr><c-f> lsp#scroll(+4)
	nnoremap <buffer> <expr><c-d> lsp#scroll(-4)

	g:lsp_format_sync_timeout = 1000
	autocmd! BufWritePre *.rs execute('LspDocumentFormatSync')
enddef

augroup lsp_install
	au!
	autocmd User lsp_buffer_enabled On_lsp_buffer_enabled()
augroup END

# vim: set ft=vim :
